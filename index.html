<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>IG Square Pro</title>
    
    <!-- PWA 與 iOS 設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="IG Square">
    
    <!-- App 圖示：目前設定為專業相機風格圖示 -->
    <!-- 若要更換，請將下方連結替換為你的圖片網址 -->
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3659/3659899.png">
    
    <!-- 載入外部套件 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#F2F2F7]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        
        // 封裝滑桿組件
        function Slider({ label, min, max, step, value, onChange, onToggle }) {
            return (
                <div className="space-y-1">
                    <div className="flex justify-between text-[10px] font-bold text-gray-400 uppercase tracking-tighter">
                        <span>{label}</span>
                        <span className={value === 0 ? 'text-red-500' : 'text-gray-900'}>
                            {value === 0 ? '已置中' : value}
                        </span>
                    </div>
                    <input 
                        type="range" 
                        min={min} 
                        max={max} 
                        step={step} 
                        value={value} 
                        onMouseDown={() => onToggle && onToggle(true)} 
                        onMouseUp={() => onToggle && onToggle(false)}
                        onTouchStart={() => onToggle && onToggle(true)} 
                        onTouchEnd={() => onToggle && onToggle(false)}
                        onChange={e => onChange(parseFloat(e.target.value))} 
                        className="w-full h-1.5 bg-gray-200 rounded-lg appearance-none accent-blue-600 cursor-pointer" 
                    />
                </div>
            );
        }

        // 畫布預覽組件
        function CanvasPreview({ img, size }) {
            const ref = useRef(null);
            useEffect(() => {
                const ctx = ref.current.getContext('2d');
                // 繪製背景
                ctx.fillStyle = img.bgColor;
                ctx.fillRect(0, 0, size, size);
                
                // 計算繪製尺寸
                const s = img.baseScale * img.scale;
                const w = img.element.width * s;
                const h = img.element.height * s;
                const x = (size - w) / 2 + img.offsetX;
                const y = (size - h) / 2 + img.offsetY;
                
                // 繪製圖片
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(img.element, x, y, w, h);
                
                // 繪製輔助線
                if (img.isAdjusting) {
                    const isCenteredX = Math.abs(img.offsetX) < 10;
                    const isCenteredY = Math.abs(img.offsetY) < 10;
                    
                    if (isCenteredX || isCenteredY) {
                        ctx.strokeStyle = '#ff3b30';
                        ctx.lineWidth = 4;
                        ctx.setLineDash([20, 20]);
                        ctx.beginPath();
                        if (isCenteredX) { ctx.moveTo(size/2, 0); ctx.lineTo(size/2, size); }
                        if (isCenteredY) { ctx.moveTo(0, size/2); ctx.lineTo(size, size/2); }
                        ctx.stroke();
                    }
                }
            }, [img]);
            return <canvas ref={ref} width={size} height={size} className="w-full h-full object-contain shadow-sm bg-white rounded-2xl border border-gray-100" />;
        }

        function App() {
            const [images, setImages] = useState([]);
            const fileInputRef = useRef(null);
            const CANVAS_SIZE = 1080;

            const handleUpload = (e) => {
                const files = Array.from(e.target.files);
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            const initialScale = CANVAS_SIZE / Math.max(img.width, img.height);
                            setImages(prev => [...prev, {
                                id: crypto.randomUUID(),
                                name: file.name.split('.')[0],
                                element: img,
                                scale: 1,
                                baseScale: initialScale,
                                offsetX: 0,
                                offsetY: 0,
                                bgColor: '#ffffff',
                                isAdjusting: false,
                                isExpanded: true
                            }]);
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            };

            const updateImg = (id, key, val) => {
                setImages(prev => prev.map(i => i.id === id ? { ...i, [key]: val } : i));
            };

            const download = (img) => {
                const canvas = document.createElement('canvas');
                canvas.width = canvas.height = CANVAS_SIZE;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = img.bgColor;
                ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
                const s = img.baseScale * img.scale;
                const w = img.element.width * s;
                const h = img.element.height * s;
                ctx.drawImage(img.element, (CANVAS_SIZE-w)/2 + img.offsetX, (CANVAS_SIZE-h)/2 + img.offsetY, w, h);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
                const win = window.open();
                win.document.write(`
                    <html>
                        <head><title>儲存相片</title><meta name="viewport" content="width=device-width, initial-scale=1"></head>
                        <body style="margin:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#000;min-height:100vh;font-family:sans-serif;">
                            <img src="${dataUrl}" style="width:100%;max-width:500px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.5);" />
                            <p style="color:#fff;margin-top:20px;font-weight:bold;">長按圖片儲存到相簿</p>
                            <button onclick="window.close()" style="margin-top:20px;padding:12px 30px;border-radius:25px;border:none;background:#fff;font-weight:bold;cursor:pointer;">返回 App</button>
                        </body>
                    </html>
                `);
            };

            const presets = ['#ffffff', '#000000', '#F2F2F7', '#FFE5EC', '#FEFAE0'];

            return (
                <div className="min-h-screen flex flex-col items-center pb-40" style={{ paddingTop: 'env(safe-area-inset-top)' }}>
                    <header className="w-full max-w-lg px-6 pt-12 mb-6">
                        <h1 className="text-4xl font-black tracking-tight text-gray-900">IG Square</h1>
                        <p className="text-gray-500 text-sm font-medium mt-1">Batch Editor Pro</p>
                    </header>

                    <div className="w-full max-w-lg px-4 space-y-6">
                        {images.map(img => (
                            <div key={img.id} className="bg-white rounded-[2.5rem] shadow-sm overflow-hidden border border-gray-100 transition-all">
                                <div className="p-5 flex items-center justify-between" onClick={() => updateImg(img.id, 'isExpanded', !img.isExpanded)}>
                                    <div className="flex items-center gap-4">
                                        <div className="w-12 h-12 rounded-2xl overflow-hidden bg-gray-100 shadow-inner">
                                            <img src={img.element.src} className="w-full h-full object-cover" />
                                        </div>
                                        <span className="font-bold text-sm text-gray-700 truncate w-32">{img.name}</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); download(img); }} 
                                            className="bg-blue-600 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg shadow-blue-100 active:scale-90 transition-all"
                                        >
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                        </button>
                                        <button onClick={(e) => { e.stopPropagation(); setImages(images.filter(i => i.id !== img.id)); }} className="w-10 h-10 text-gray-300 flex items-center justify-center">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                        </button>
                                    </div>
                                </div>
                                
                                {img.isExpanded && (
                                    <div className="px-6 pb-8 space-y-6 animate-in fade-in zoom-in-95 duration-300">
                                        <div className="aspect-square">
                                            <CanvasPreview img={img} size={CANVAS_SIZE} />
                                        </div>
                                        
                                        <div className="space-y-5 pt-2">
                                            <Slider 
                                                label="縮放尺寸" 
                                                min="0.5" max="2.5" step="0.01" 
                                                value={img.scale} 
                                                onChange={v => updateImg(img.id, 'scale', v)} 
                                                onToggle={s => updateImg(img.id, 'isAdjusting', s)} 
                                            />
                                            
                                            <div className="grid grid-cols-2 gap-6">
                                                <Slider 
                                                    label="水平位移" 
                                                    min="-600" max="600" step="1" 
                                                    value={img.offsetX} 
                                                    onChange={v => updateImg(img.id, 'offsetX', Math.abs(v) < 10 ? 0 : v)} 
                                                    onToggle={s => updateImg(img.id, 'isAdjusting', s)} 
                                                />
                                                <Slider 
                                                    label="垂直位移" 
                                                    min="-600" max="600" step="1" 
                                                    value={img.offsetY} 
                                                    onChange={v => updateImg(img.id, 'offsetY', Math.abs(v) < 10 ? 0 : v)} 
                                                    onToggle={s => updateImg(img.id, 'isAdjusting', s)} 
                                                />
                                            </div>

                                            <div className="space-y-3 pt-2">
                                                <span className="text-[10px] font-bold text-gray-400 uppercase tracking-widest block">背景顏色</span>
                                                <div className="flex items-center gap-2">
                                                    {presets.map(color => (
                                                        <button 
                                                            key={color} 
                                                            onClick={() => updateImg(img.id, 'bgColor', color)}
                                                            className={`w-8 h-8 rounded-full border-2 transition-transform active:scale-90 ${img.bgColor === color ? 'border-blue-500 scale-110' : 'border-gray-100'}`}
                                                            style={{ backgroundColor: color }}
                                                        />
                                                    ))}
                                                    <div className="w-8 h-8 rounded-full border-2 border-dashed border-gray-200 flex items-center justify-center relative overflow-hidden bg-white group">
                                                        <input 
                                                            type="color" 
                                                            value={img.bgColor} 
                                                            onChange={e => updateImg(img.id, 'bgColor', e.target.value)} 
                                                            className="absolute inset-0 scale-[3] bg-transparent border-none cursor-pointer" 
                                                        />
                                                        <span className="text-[18px] font-light text-gray-300 pointer-events-none">+</span>
                                                    </div>
                                                    <span className="ml-auto text-[10px] font-mono text-gray-400 font-bold uppercase">{img.bgColor}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}

                        {images.length === 0 && (
                            <div className="py-32 text-center text-gray-300">
                                <div className="w-20 h-20 bg-white rounded-[2rem] shadow-sm border border-gray-100 mx-auto flex items-center justify-center mb-6">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="opacity-20"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                                </div>
                                <p className="font-bold text-gray-400">尚未上傳相片</p>
                                <p className="text-xs mt-1 text-gray-300">點擊下方按鈕開始製作</p>
                            </div>
                        )}
                    </div>

                    <div className="fixed bottom-10 w-full max-w-xs z-50 px-4">
                        <button 
                            onClick={() => fileInputRef.current.click()} 
                            className="w-full py-4 bg-black text-white rounded-2xl font-bold shadow-2xl active:scale-95 transition-all flex items-center justify-center gap-3"
                        >
                            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                            批量選取相片
                        </button>
                    </div>
                    
                    <input type="file" ref={fileInputRef} onChange={handleUpload} multiple accept="image/*" className="hidden" />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
